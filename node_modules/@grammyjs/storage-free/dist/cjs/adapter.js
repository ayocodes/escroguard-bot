"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.freeStorage = void 0;
class Storage {
    constructor(token, rootUrl = 'https://grammy-free-session.deno.dev/api') {
        this.token = token;
        this.rootUrl = rootUrl;
    }
    async login() {
        if (this.jwt === undefined) {
            const url = `${this.rootUrl}/login`;
            const body = JSON.stringify({ token: this.token });
            const response = await retryFetch(url, { method: 'POST', body });
            const { token } = await response.json();
            if (typeof token !== 'string') {
                throw new Error('Cannot use free session, invalid bot token!');
            }
            this.jwt = token;
        }
        return this.jwt;
    }
    logout() {
        this.jwt = undefined;
    }
    async call(method, key, body) {
        // perform request
        const url = `${this.rootUrl}/session/${key}`;
        const jwt = await this.login();
        const headers = { 'Authorization': `Bearer ${jwt}` };
        const response = await retryFetch(url, { method, body, headers });
        // handle response
        if (response.status === 401) {
            // token was revoked, must login again
            this.logout();
            return await this.call(method, key, body);
        }
        else if (response.status === 404) {
            // empty session
            return undefined;
        }
        else if (200 <= response.status && response.status < 300) {
            // success
            return method === 'GET' ? await response.text() : undefined;
        }
        else {
            // error
            throw new Error(`${response.status}: ${(await response.json()).error}`);
        }
    }
}
/**
 * @param token The bot token of your bot.
 * @param opts Further configuration options
 * @returns An adapter to grammY's free session storage
 */
function freeStorage(token, opts) {
    const storage = new Storage(token, opts === null || opts === void 0 ? void 0 : opts.rootUrl);
    if ((opts === null || opts === void 0 ? void 0 : opts.jwt) !== undefined)
        storage.jwt = opts.jwt;
    return {
        async read(key) {
            const session = await storage.call('GET', key);
            return session === undefined ? undefined : JSON.parse(session);
        },
        async write(key, data) {
            await storage.call('POST', key, JSON.stringify(data));
        },
        async delete(key) {
            await storage.call('DELETE', key);
        },
        /**
         * Returns the storage authentication token which is used to store the
         * session data. Only useful if you want to avoid the login call that will
         * be performed automatically when the storage adapter contacts its backend
         * for the first time. This can improve startup performance and is
         * especially useful in serverless environments.
         */
        async getToken() {
            return await storage.login();
        },
    };
}
exports.freeStorage = freeStorage;
async function retryFetch(...args) {
    let res;
    let delay = 10; // ms
    do {
        res = await (0, shim_node_js_1.fetch)(...args);
        if (res.status >= 500) {
            console.error(`${res.status} in free session service, retrying!`);
            await sleep(delay);
            delay += delay; // exponential back-off
            delay = Math.min(delay, 1000 * 60 * 60); // cap at 1 hour
        }
    } while (res.status >= 500);
    return res;
}
async function sleep(ms) {
    await new Promise((r) => setTimeout(r, ms));
}
const shim_node_js_1 = require("./shim.node.js");
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLE1BQU0sT0FBTztJQUVYLFlBQ21CLEtBQWEsRUFDYixVQUFVLDBDQUEwQztRQURwRCxVQUFLLEdBQUwsS0FBSyxDQUFRO1FBQ2IsWUFBTyxHQUFQLE9BQU8sQ0FBNkM7SUFDcEUsQ0FBQztJQUVKLEtBQUssQ0FBQyxLQUFLO1FBQ1QsSUFBSSxJQUFJLENBQUMsR0FBRyxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQzNCLE1BQU0sR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLE9BQU8sUUFBUSxDQUFDO1lBQ3BDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7WUFDbkQsTUFBTSxRQUFRLEdBQUcsTUFBTSxVQUFVLENBQUMsR0FBRyxFQUFFLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ2pFLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxNQUFNLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUN4QyxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRSxDQUFDO2dCQUM5QixNQUFNLElBQUksS0FBSyxDQUFDLDZDQUE2QyxDQUFDLENBQUM7WUFDakUsQ0FBQztZQUNELElBQUksQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDO1FBQ25CLENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDbEIsQ0FBQztJQUVELE1BQU07UUFDSixJQUFJLENBQUMsR0FBRyxHQUFHLFNBQVMsQ0FBQztJQUN2QixDQUFDO0lBRUQsS0FBSyxDQUFDLElBQUksQ0FDUixNQUFpQyxFQUNqQyxHQUFXLEVBQ1gsSUFBYTtRQUViLGtCQUFrQjtRQUNsQixNQUFNLEdBQUcsR0FBRyxH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